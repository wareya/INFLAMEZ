[gd_scene load_steps=6 format=2]

[ext_resource path="res://Sprites/punk rocker.png" type="Texture" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends KinematicBody2D

func _ready():
    pass

const topspeed = 75.0
const jumpspeed = 190.0
const gravity = 500.0
const bad_slope_limit = 0.7 # not a normal

var walk_state = 0
var look_direction = 1

var velocity : Vector2 = Vector2(0, 0)

var want_to_jump = false

const max_fire = 120
var fire = max_fire

const walljump_consumed_fire = 5
const walljump_timer_max = 1.0
var walljump_timer = 0
var walljumping_enabled = true
var walljump_xvel = 0 # dynamic

func get_which_wall_collided():
    for i in range(get_slide_count()):
        var collision = get_slide_collision(i)
        if collision.normal.x > 0.9:
            return 1
        elif collision.normal.x < -0.9:
            return -1
    return 0

func _physics_process(delta):
    var previous_walk_state = walk_state
    if Input.is_action_pressed(\"ui_left\") and !Input.is_action_pressed(\"ui_right\"):
        walk_state = -1
    if !Input.is_action_pressed(\"ui_left\") and Input.is_action_pressed(\"ui_right\"):
        walk_state = 1
        
    if Input.is_action_just_pressed(\"ui_left\"):
        walk_state = -1
        walljump_timer = 0
    if Input.is_action_just_pressed(\"ui_right\"):
        walk_state = 1
        walljump_timer = 0
    
    if !Input.is_action_pressed(\"ui_left\") and !Input.is_action_pressed(\"ui_right\"):
        walk_state = 0
    
    if walk_state != 0:
        look_direction = walk_state
    
    $Sprite.transform.x.x = look_direction
    
    if walljump_timer <= 0:
        velocity.x = walk_state * topspeed
    if walljump_timer > 0:
        var derp = walljump_timer/walljump_timer_max
        derp = derp*derp
        velocity.x = lerp(walljump_xvel, walk_state * topspeed, 1-derp)
        walljump_timer -= delta
    
    if Input.is_action_just_pressed(\"jump\"):
        walljump_timer = 0
        want_to_jump = true
    if !Input.is_action_pressed(\"jump\"):
        walljump_timer = 0
        want_to_jump = false
    
    if want_to_jump and is_on_floor():
        velocity.y = -jumpspeed
        want_to_jump = false
    if walljumping_enabled and want_to_jump and is_on_wall():
        var walldir = get_which_wall_collided()
        if walldir != 0:
            velocity.y = -jumpspeed*0.8
            velocity.x = jumpspeed*walldir*0.3
            walljump_xvel = velocity.x
            walljump_timer = walljump_timer_max
            want_to_jump = false
            fire -= walljump_consumed_fire
    
    print(walljump_timer)
    
    if Input.is_action_just_released(\"jump\") and velocity.y < 0:
        velocity.y /= 2
    
    if is_on_floor() and walk_state != previous_walk_state:
        velocity.y = 0
    
    for torch in get_tree().get_nodes_in_group(\"StandTorch\"):
        if torch.overlaps_body(self):
            if fire > 0:
                torch.lit = fire
            if torch.lit:
                fire = max_fire
        pass
    
    velocity.y += gravity*delta/2
    
    var floor_snap = Vector2(0, 4)
    if velocity.y < 0:
        floor_snap = Vector2(0, 0)
    
    var old_velocity_y = velocity.y
    
    velocity = move_and_slide_with_snap(velocity, floor_snap, Vector2(0, -1), true)
    if velocity.y < old_velocity_y and !is_on_floor() and velocity.y < -bad_slope_limit:
        velocity.y = -bad_slope_limit
    
    velocity.y += gravity*delta/2
    
    $Camera.position = Vector2(0, 0)
    $Camera.global_position.x = round($Camera.global_position.x)
    $Camera.global_position.y = round($Camera.global_position.y)
    $Sprite.position = Vector2(0, 0)
    $Sprite.global_position.x = round($Sprite.global_position.x)
    $Sprite.global_position.y = round($Sprite.global_position.y)
    
    fire -= delta
    
    $Camera/Fire.value = fire/max_fire*100
    
    pass
"

[sub_resource type="ConvexPolygonShape2D" id=2]
points = PoolVector2Array( -1, -7, 1, -7, 3, -5, 3, 6, 1, 8, -1, 8, -3, 6, -3, -5 )

[sub_resource type="StyleBoxFlat" id=3]
bg_color = Color( 0.901961, 0.431373, 0.32549, 1 )
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_color = Color( 0, 0, 0, 0 )
anti_aliasing = false

[sub_resource type="StyleBoxFlat" id=4]
bg_color = Color( 0.231373, 0.231373, 0.231373, 0.333333 )
border_width_left = 1
border_width_top = 1
border_width_right = 1
border_width_bottom = 1
border_color = Color( 0, 0, 0, 0.396078 )
corner_radius_top_left = 2
corner_radius_top_right = 2
corner_radius_bottom_right = 1
corner_radius_bottom_left = 1
corner_detail = 1
anti_aliasing = false

[node name="MyChar" type="KinematicBody2D" groups=[
"Player",
]]
collision_mask = 2
script = SubResource( 1 )

[node name="Viewport" type="Viewport" parent="."]
size = Vector2( 320, 180 )
usage = 0
render_direct_to_screen = true

[node name="Sprite" type="Sprite" parent="."]
texture = ExtResource( 1 )

[node name="Hull" type="CollisionShape2D" parent="."]
shape = SubResource( 2 )

[node name="Camera" type="Camera2D" parent="."]
current = true

[node name="Fire" type="ProgressBar" parent="Camera"]
margin_left = 128.0
margin_right = 192.0
margin_bottom = 8.0
rect_rotation = -90.0
custom_styles/fg = SubResource( 3 )
custom_styles/bg = SubResource( 4 )
rounded = true
percent_visible = false
__meta__ = {
"_edit_use_anchors_": false
}
